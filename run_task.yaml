trigger:
  branches:
    include:
      - main

stages:
  - stage: ValidateOauthToken
    displayName: 'Validate Oauth Token'
    jobs:
      - job: CheckToken
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - script: |
              echo "Triggering Databricks job..."
            displayName: 'Call Databricks Job and Print Response'

  - stage: ValidateStorageAccessPolicy
    displayName: 'Validate storage access policies'
    dependsOn: ValidateOauthToken
    jobs:
      - job: ValidateOauth
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - script: |
              echo "Validate why file is not generated by going through logs"
            displayName: 'Analyze logs for missing file'

  - stage: RetryJob
    displayName: 'Retry job'
    dependsOn: ValidateStorageAccessPolicy
    jobs:
      - job: TriggerJob
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - script: |
              echo "Trigger job to generate the file"
              RESPONSE=$(curl --location 'https://dbc-bd38953b-53cc.cloud.databricks.com/api/2.1/jobs/run-now' \
                --header 'Authorization: Bearer dapiccb98aad2dda701c33f67fb4fba4fe2f' \
                --header 'Content-Type: application/json' \
                --data '{
                  "job_id": 477162549764416
                }')
              echo "ðŸ“¡ Databricks API Response:"
              echo "$RESPONSE"
            displayName: 'Run file generation job'
