trigger:
  branches:
    include:
      - main
 
stages:
  - stage: ValidateFileGenerated
    displayName: 'Validate if file is generated'
    jobs:
      - job: CheckFile
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - script: |
              echo "‚úÖ Triggering Databricks job..."
              RESPONSE=$(curl --location 'https://dbc-bd38953b-53cc.cloud.databricks.com/api/2.1/jobs/run-now' \
                --header 'Authorization: Bearer dapiccb98aad2dda701c33f67fb4fba4fe2f' \
                --header 'Content-Type: application/json' \
                --data '{
                  "job_id": 477162549764416
                }')
              echo "üì° Databricks API Response:"
              echo "$RESPONSE"
            displayName: 'Call Databricks Job and Print Response'
 
  - stage: DebugMissingFile
    displayName: 'Validate why file is not generated by going through logs'
    dependsOn: ValidateFileGenerated
    jobs:
      - job: DebugFileMissing
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - script: echo "üîç Validate why file is not generated by going through logs"
            displayName: 'Analyze logs for missing file'
 
  - stage: TriggerFileGeneration
    displayName: 'Trigger job to generate the file'
    dependsOn: DebugMissingFile
    jobs:
      - job: TriggerJob
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - script: echo "üöÄ Trigger job to generate the file"
            displayName: 'Run file generation job'
 
  - stage: ValidateFileAgain
    displayName: 'Validate if file generated'
    dependsOn: TriggerFileGeneration
    jobs:
      - job: ValidateFile
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - script: echo "‚úÖ Validate if file generated"
            displayName: 'Re-check if file exists'

